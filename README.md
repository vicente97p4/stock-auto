# stock-auto-trading-system  

<img src="https://img.shields.io/badge/-python-white?style=flat&logo=python"/></a>

---
## 전체 시스템의 구성
---
> **클라이언트**  
> **API 서버 - 수집, 매매**  
> **저장 모듈**                          
> **저장소(MongoDB)**  
(위아래로 인접한 모듈끼리 상호작용 함)  

<-> 홈페이지, 증권사, 공공데이터에서 데이터 가져와서 활용

- 클라이언트 프로그램은 웹을 이용해 사용자에게 화면을 제공  
- 프로그램이 수행된 로직에 의해 최종적으로 데이터가 저장소에 반영됨  
- 수집과 매매를 지원하는 모듈은 매일, 매시, 매분 자동으로 데이터를 수집, 변경함.  

데이터가 이동하는 최종 목적지는 저장소이며, 저장소에 접근하려면 **저장 모듈**을 거쳐서 반영 가능하다.  
> 보안이나 기능적으로 제한된 방법만 허용함으로써 오류를 줄이고 무분별한 요청을 막을 수 있게 처리한다.

외부로 기능을 제공하는 API 역시 저장 모듈을 이용해 저장소에 있는 데이터에 접근하거나 변경할 수 있다.  

최종 클라이언트 프로그램, 웹은 특정한 화면에서 API 서버로 요청을 하게 되며, API 서버로부터 반환받은 데이터를 화면으로 제공하거나 변경한다.  

---
## 프로젝트 모듈 구성
---
### 1. 수집, 매매 모듈
</br>

- 주식 거래와 데이터 분석에 필요한 데이터를 수집하는 모듈  
- 종목의 가격 정보와 종목과 관련된 여러가지 정보 수집
- 주식 관련 거래와 가격 정보는 증권사 API 이용, 매수, 매도할 수 있는 주문 기능 제공
- 증권사에서 얻을 수 없는 정보는 공공데이터와 웹페이지에서 얻어옴

### 2. 저장 모듈(데이터의 저장, 변경을 지원)
</br>

- 여러 경로로부터 데이터의 저장, 변경, 삭제 요청을 받아서 저장소에 직접 실행하는 모듈  
- 저장소에는 저장 모듈을 통해서만 접근 가능  
- 저장소에 일으키는 명령을 제어하고 로깅하기 쉬우며 무분별한 접근을 차단하고, 공통적인 역할을 손쉽게 처리하기 위해 저장 모듈을 따로 두어 접근하게 설계함  
- MongoDB 사용 - 문서 기반 DB로 스키마가 자유로운 장점이 있으나 복잡한 계산을 요구하는 쿼리는 구현이 복잡해질 수 있음. 하지만 이 프로젝트의 쿼리는 단순하기 때문에 MongoDB를 사용했음  

### 3. API 서버
</br>

- 클라이언트나 웹과 통신하기 위한 API 서버를 구축, API 서버는 외부 클라이언트나 웹이 저장소의 데이터를 이용하기 위한 다리 역할을 한다.  
- UI에서 사용자가 특정 행위를 하면 클라이언트 프로그램은 특정 행위에 해당하는 정보를 API 서버에 요청하고, 그 값을 돌려받은 후 다시 UI에 정보를 갱신해주는 형태로 동작한다.  
- 이렇게 웹이 요청하는 정보를 제공하기 위한 API 서버는 RESTFul 기반으로 진행한다.  

### 4. 클라이언트(웹)
</br>

- API 서버와 통신하며 자동 거래 시스템에 필요한 웹
- 클라이언트 프로그램이 없다면 저장된 데이터를 조회할 때마다 직접 저장소로 들어가서 매번 쿼리를 수행해 필요한 결과를 얻어야 함. 이를 방지하기 위해 웹을 개발함
- 리엑트를 기반으로 개발하며 기본적인 종목 데이터 선택, 데이터 조회, 차트를 지원하는 UI를 웹으로 개발

### 5. (추가)데이터 분석
</br>

- 필요한 데이터를 가공하고 간단한 차트를 그림  

---
## 프로젝트 패키지 구성
---

### 프로젝트 패키지 구조  

```
stocklab ──── agent
│          ├─ db_handler
│          ├─ scheduler
│          └─ tests 
├── scripts
├── 일지
└── README.md
```

- agent : 수집과 매매를 지원하는 모듈
- db_handler : MongoDB에 저장, 변경을 지원하는 모듈
- scheduler : 스케쥴러 모듈(주기적인 작업을 수행하기 위한 모듈)  
- tests : 테스트 파일들이 들어있는 폴더(모듈 아님)  

- scripts: 윈도우의 작업 스케줄러를 이용해 스크립트를 주기적으로 실행한다. 이때 스크립트들이 위한 폴더

(파이썬은 폴더에 있는 __init__.py 파일이 해당 폴더가 패키지임을 알려주는 역할을 한다.)

---

### 스케줄러

---

- apscheduler에서 제공하는 BackgroundScheduler를 사용한다.
- 그런데 BackgroundScheduler를 이용해 일반적으로 EBest 모듈을 호출하게 되면 정상적으로 동작하지 않는다.
> EBest가 win32com 패키지를 사용하면서 내부적으로 프로세스와 관련된 동작을 하는데 이때 BackgroundScheduler에서 win32com이 정상적으로 호출되지 않는다.

- 이를 해결하기 위해 멀티프로세싱으로 별도의 프로세스를 하나 더 생성해서 EBest 모듈을 수행한다.

1. Scheduler에서 job1과 job2 생성

2. job1은 종목 코드를 가져오는 run_process_collect_code_list 메서드를 호출하고, job2는 종목별 가격 정보를 가져오는 run_process_collect_stock_info 메서드를 호출한다.

3. run_process_collect_code_list는 collect_code_list를 호출해 프로세스를 생성하고, collect_stock_info도 별도의 프로세스를 생성한다.

4. 개별 프로세서는 ebesst와 mongodb 객체를 생성해 종목 코드를 수집하고, 종목별 가격 정보를 수집한다.

작업을 수행할 시간을 지정할 때 크론(cron) 방식을 사용한다.

```
크론(cron) 방식

*  *  *  *  *
분 시 일 월 요일

*은 매 분, 매 시, 매일 등 매번을 의미

*/5 * * * * : 매 5분 단위를 의미

25, 45 * * * * : 매시간 25분, 45분 의미

0 6 * * 1-3 : 월,화,수요일 6시를 의미
```